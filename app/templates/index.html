<!-- app/templates/index.html -->
{% extends "base.html" %}

{% block title %}ğŸ’– æˆ‘ä»¬çš„æ‹çˆ± Todo{% endblock %}

{% block extra_css %}
<style>
    /* é¦–é¡µç‰¹å®šæ ·å¼ */
    .welcome-section {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 142, 83, 0.1));
        border-radius: 15px;
    }

    .days-counter {
        font-size: 1.5rem;
        font-weight: 600;
        color: #ff6b6b;
        margin: 20px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .greeting-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border-left: 4px solid #ff6b6b;
    }

    .greeting-content {
        font-size: 1.1rem;
        line-height: 1.6;
        color: #333;
    }

    /* å¾…åŠè¡¨å• */
    .todo-form {
        background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
    }

    .todo-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .todo-input {
        flex: 1;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .todo-input:focus {
        outline: none;
        border-color: #ff6b6b;
        box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    }

    .todo-submit-btn {
        background: linear-gradient(135deg, #ff6b6b, #ff8e53);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .todo-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
    }

    /* å¾…åŠåˆ—è¡¨ */
    .todos-container {
        margin-top: 20px;
    }

    .todo-item {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        border-left: 4px solid #ff6b6b;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .todo-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .todo-item.done {
        border-left-color: #06d6a0;
        opacity: 0.8;
    }

    .todo-checkbox {
        width: 22px;
        height: 22px;
        cursor: pointer;
        accent-color: #06d6a0;
        flex-shrink: 0;
    }

    .todo-content {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .todo-text {
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }

    .todo-item.done .todo-text {
        text-decoration: line-through;
        color: #888;
    }

    .todo-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .todo-item:hover .todo-actions {
        opacity: 1;
    }

    .todo-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .todo-btn.complete {
        background: #06d6a0;
        color: white;
    }

    .todo-btn.complete:hover {
        background: #05a37e;
    }

    .todo-btn.delete {
        background: #ef4444;
        color: white;
    }

    .todo-btn.delete:hover {
        background: #dc2626;
    }

    .todo-btn.undo {
        background: #3b82f6;
        color: white;
    }

    .todo-btn.undo:hover {
        background: #2563eb;
    }

    /* ç­›é€‰å’Œç»Ÿè®¡ */
    .todos-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .todos-filters {
        display: flex;
        gap: 10px;
    }

    .filter-btn {
        padding: 8px 16px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .filter-btn.active {
        background: #ff6b6b;
        color: white;
        border-color: #ff6b6b;
    }

    .filter-btn:hover:not(.active) {
        border-color: #ff6b6b;
        color: #ff6b6b;
    }

    .todos-stats {
        font-size: 0.9rem;
        color: #666;
    }

    /* ç©ºçŠ¶æ€ */
    .todos-empty {
        text-align: center;
        padding: 60px 20px;
        color: #888;
    }

    .todos-empty-icon {
        font-size: 4rem;
        color: #e0e0e0;
        margin-bottom: 20px;
    }

    /* è§’è‰²ç‰¹å®šæ ·å¼ */
    body.her {
        background: linear-gradient(135deg, #fff5f8 0%, #ffeef4 100%);
    }

    body.her .page-header h1 {
        color: #e75480;
    }

    body.her .greeting-card {
        background: #ffe4ec;
    }

    body.me {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    body.me .greeting-card {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="welcome-section">
    <h1><i class="fas fa-heart"></i> æˆ‘ä»¬çš„æ‹çˆ± Todo</h1>
    <div id="days" class="days-counter">
        <i class="fas fa-heartbeat"></i>
        <span>ğŸ’ è®¡ç®—æ‹çˆ±å¤©æ•°ä¸­...</span>
    </div>
</div>

{% if greeting %}
<div class="greeting-card">
    <div class="greeting-content">
        {{ greeting }}
    </div>
</div>
{% endif %}

<div class="todo-form">
    <form id="todo-form">
        <div class="todo-input-group">
            <input type="text"
                   id="todo-input"
                   class="todo-input"
                   placeholder="å†™ä¸‹æƒ³å’ŒTAä¸€èµ·åšçš„å°äº‹..."
                   required>
            <button type="submit" class="todo-submit-btn">
                <i class="fas fa-plus"></i> æ·»åŠ 
            </button>
        </div>
    </form>
</div>

<div class="todos-controls">
    <div class="todos-filters">
        <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
        <button class="filter-btn" data-filter="active">è¿›è¡Œä¸­</button>
        <button class="filter-btn" data-filter="completed">å·²å®Œæˆ</button>
    </div>

    <div class="todos-stats">
        <span id="todo-count">0</span>
<!--        <span id="completed-count">0</span> ä¸ªå·²å®Œæˆ-->
    </div>
</div>

<div id="todos-container" class="todos-container">
    <!-- å¾…åŠäº‹é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
</div>

<div id="todos-empty" class="card todos-empty" style="display: none;">
    <i class="fas fa-clipboard-check todos-empty-icon"></i>
    <h3>è¿˜æ²¡æœ‰å¾…åŠäº‹é¡¹</h3>
    <p>æ·»åŠ ä¸€äº›æƒ³å’ŒTAä¸€èµ·å®Œæˆçš„å°ç›®æ ‡å§ï¼</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Toast é€šçŸ¥ç»„ä»¶ï¼ˆä¸åŠ¨æ€é¡µé¢ä¿æŒä¸€è‡´ï¼‰
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // å…¨å±€å˜é‡
    let currentFilter = 'all';
    let todosData = [];

    // åŠ è½½æ‹çˆ±å¤©æ•°
    async function loadDays() {
        try {
            const res = await fetch("/love/days");
            const data = await res.json();
            const daysElement = document.getElementById('days');
            if (daysElement) {
                daysElement.innerHTML = `
                    <i class="fas fa-heartbeat"></i>
                    <span>ğŸ’ æˆ‘ä»¬å·²ç»åœ¨ä¸€èµ· ${data.days} å¤©äº†</span>
                `;
            }
        } catch (error) {
            console.error("åŠ è½½æ‹çˆ±å¤©æ•°å¤±è´¥:", error);
        }
    }

    // åŠ è½½å¾…åŠäº‹é¡¹
    async function loadTodos() {
        try {
            const res = await fetch('/todos/');

            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }

            allTodosData = await res.json();
            applyFilter();

        } catch (error) {
            console.error("åŠ è½½å¾…åŠäº‹é¡¹å¤±è´¥:", error);
            showToast('åŠ è½½å¾…åŠäº‹é¡¹å¤±è´¥', 'error');
        }
    }
    function applyFilter() {
        if (currentFilter === 'all') {
            filteredTodosData = [...allTodosData]; // å¤åˆ¶æ•°ç»„
        } else if (currentFilter === 'active') {
            filteredTodosData = allTodosData.filter(todo => !todo.done);
        } else if (currentFilter === 'completed') {
            filteredTodosData = allTodosData.filter(todo => todo.done);
        }

        renderTodos(filteredTodosData);
        updateStats(allTodosData);
    }

    // æ¸²æŸ“å¾…åŠäº‹é¡¹
    function renderTodos(todos) {
        const container = document.getElementById('todos-container');
        const emptyState = document.getElementById('todos-empty');

        if (todos.length === 0) {
            container.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        container.style.display = 'block';
        emptyState.style.display = 'none';

        container.innerHTML = '';

        todos.forEach(todo => {
            const todoElement = createTodoElement(todo);
            container.appendChild(todoElement);
        });
    }

    // åˆ›å»ºå•ä¸ªå¾…åŠäº‹é¡¹å…ƒç´ 
    function createTodoElement(todo) {
        const div = document.createElement('div');
        div.className = `todo-item ${todo.done ? 'done' : ''}`;
        div.id = `todo-${todo.id}`;

        const actionButton = todo.done ? `
            <button class="todo-btn undo" onclick="undoTodo(${todo.id})">
                <i class="fas fa-undo"></i> å–æ¶ˆå®Œæˆ
            </button>
        ` : `
            <button class="todo-btn complete" onclick="completeTodo(${todo.id})">
                <i class="fas fa-check"></i> å®Œæˆ
            </button>
        `;

        div.innerHTML = `
            <input type="checkbox" class="todo-checkbox" ${todo.done ? 'checked' : ''}
                   onchange="toggleTodo(${todo.id}, ${!todo.done})">
            <div class="todo-content">
                <span class="todo-text">${todo.title}</span>
                <div class="todo-actions">
                    ${actionButton}
                    <button class="todo-btn delete" onclick="deleteTodo(${todo.id})">
                        <i class="fas fa-trash"></i> åˆ é™¤
                    </button>
                </div>
            </div>
        `;

        return div;
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(todos) {
        const total = todos.length;
        const completed = todos.filter(todo => todo.done).length;
        const active = total - completed;

        // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶æ›´æ–°æ˜¾ç¤º
        let displayText;
        if (currentFilter === 'all') {
            displayText = `${total} ä¸ªå¾…åŠ (${active} è¿›è¡Œä¸­, ${completed} å·²å®Œæˆ)`;
        } else if (currentFilter === 'active') {
            displayText = `${active} ä¸ªè¿›è¡Œä¸­çš„å¾…åŠ`;
        } else if (currentFilter === 'completed') {
            displayText = `${completed} ä¸ªå·²å®Œæˆçš„å¾…åŠ`;
        }

        document.getElementById('todo-count').textContent = displayText;
    }

    // æ·»åŠ å¾…åŠäº‹é¡¹
    // æ·»åŠ å¾…åŠäº‹é¡¹ï¼ˆéœ€è¦åˆ·æ–°æ‰€æœ‰æ•°æ®ï¼‰
    async function addTodo() {
        const input = document.getElementById('todo-input');
        const title = input.value.trim();

        if (!title) {
            showToast('è¯·è¾“å…¥å¾…åŠäº‹é¡¹å†…å®¹', 'error');
            return;
        }

        try {
            const response = await fetch('/todos/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ title })
            });

            if (response.ok) {
                input.value = '';
                showToast('å¾…åŠäº‹é¡¹å·²æ·»åŠ ', 'success');
                await loadTodos(); // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
            } else {
                const data = await response.json();
                showToast(data.detail || 'æ·»åŠ å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error("æ·»åŠ å¾…åŠäº‹é¡¹å¤±è´¥:", error);
            showToast('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }

    // æ ‡è®°å¾…åŠäº‹é¡¹ä¸ºå®Œæˆï¼ˆéœ€è¦åˆ·æ–°æ‰€æœ‰æ•°æ®ï¼‰
    async function completeTodo(todoId) {
        try {
            const response = await fetch(`/todos/${todoId}/done`, {
                method: 'PUT',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                showToast('å¾…åŠäº‹é¡¹å·²å®Œæˆ', 'success');
                await loadTodos(); // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
            } else {
                const data = await response.json();
                showToast(data.detail || 'æ“ä½œå¤±è´¥', 'error');
            }
        } catch (error) {
            console.error("æ ‡è®°å®Œæˆå¤±è´¥:", error);
            showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            await loadTodos(); // é‡æ–°åŠ è½½ä»¥æ¢å¤çŠ¶æ€
        }
    }

    // å–æ¶ˆå®Œæˆå¾…åŠäº‹é¡¹ï¼ˆéœ€è¦åˆ·æ–°æ‰€æœ‰æ•°æ®ï¼‰
    async function undoTodo(todoId) {
        try {
            const response = await fetch(`/todos/${todoId}/undo`, {
                method: 'PUT',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                showToast('å·²å–æ¶ˆå®Œæˆ', 'success');
                await loadTodos(); // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
            } else {
                const data = await response.json();
                showToast(data.detail || 'æ“ä½œå¤±è´¥', 'error');
            }
        } catch (error) {
            console.error("å–æ¶ˆå®Œæˆå¤±è´¥:", error);
            showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }

    // åˆ‡æ¢å¾…åŠäº‹é¡¹çŠ¶æ€
    async function toggleTodo(todoId, done) {
        if (done) {
            await completeTodo(todoId);
        } else {
            await undoTodo(todoId);
        }
    }

    // åˆ é™¤å¾…åŠäº‹é¡¹ï¼ˆéœ€è¦åˆ·æ–°æ‰€æœ‰æ•°æ®ï¼‰
    async function deleteTodo(todoId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¾…åŠäº‹é¡¹å—ï¼Ÿ')) {
            return;
        }

        try {
            const response = await fetch(`/todos/${todoId}`, {
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                showToast('å¾…åŠäº‹é¡¹å·²åˆ é™¤', 'success');
                await loadTodos(); // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
            } else {
                const data = await response.json();
                showToast(data.detail || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error("åˆ é™¤å¾…åŠäº‹é¡¹å¤±è´¥:", error);
            showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }

    // ç­›é€‰å¾…åŠäº‹é¡¹ï¼ˆä¿®æ”¹ç‰ˆï¼‰
    function filterTodos(filter) {
        currentFilter = filter;

        // æ›´æ–°ç­›é€‰æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // åº”ç”¨ç­›é€‰æ¡ä»¶
        applyFilter();
    }

    // äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('todo-form').addEventListener('submit', function(e) {
        e.preventDefault();
        addTodo();
    });

    document.getElementById('todo-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            addTodo();
        }
    });

    // ç­›é€‰æŒ‰é’®äº‹ä»¶å§”æ‰˜
    document.querySelector('.todos-filters').addEventListener('click', (e) => {
        if (e.target.classList.contains('filter-btn')) {
            filterTodos(e.target.dataset.filter);
        }
    });

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadDays();
        loadTodos();

        // åˆå§‹åŒ–ç­›é€‰æŒ‰é’®çŠ¶æ€
        document.querySelector('[data-filter="all"]').classList.add('active');
    });

    // æ·»åŠ  undo è·¯ç”±ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
    // åœ¨ app/api/todo.py ä¸­æ·»åŠ ï¼š
    /*
    @router.put("/{todo_id}/undo")
    def mark_todo_undo(
        todo_id: int,
        db: Session = Depends(get_db),
        user: User = Depends(get_current_user)
    ):
        todo = db.query(Todo).filter(
            Todo.id == todo_id,
            Todo.owner_id == user.id
        ).first()

        if not todo:
            raise HTTPException(status_code=404, detail="å¾…åŠäº‹é¡¹ä¸å­˜åœ¨")

        todo.done = False
        db.commit()
        db.refresh(todo)
        return todo
    */
</script>

<style>
    /* Toast é€šçŸ¥æ ·å¼ï¼ˆä¸åŠ¨æ€é¡µé¢ä¿æŒä¸€è‡´ï¼‰ */
    .toast-notification {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        padding: 15px 25px;
        z-index: 10000;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

    .toast-notification.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    .toast-notification.success {
        border-left: 4px solid #4CAF50;
    }

    .toast-notification.error {
        border-left: 4px solid #F44336;
    }

    .toast-content {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
    }

    .toast-notification.success .toast-content i {
        color: #4CAF50;
    }

    .toast-notification.error .toast-content i {
        color: #F44336;
    }
</style>
{% endblock %}