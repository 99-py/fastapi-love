<!-- app/templates/timeline.html -->
{% extends "base.html" %}

{% block title %}ğŸ’¬ æ‹çˆ±åŠ¨æ€{% endblock %}

{% block extra_css %}
<style>
    /* åŠ¨æ€å‘å¸ƒè¡¨å• */
    .moment-form {
        background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        border-left: 4px solid #ff6b6b;
    }

    /* åŠ¨æ€åˆ—è¡¨é¡¹ */
    .moment-item {
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        border-left: 4px solid #ff6b6b;
        transition: all 0.3s ease;
    }

    .moment-item:hover {
        transform: translateX(5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .moment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .moment-user {
        font-weight: 600;
        color: #ff6b6b;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .moment-time {
        color: #888;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .moment-content {
        margin-bottom: 20px;
        line-height: 1.6;
        font-size: 1.05rem;
        padding-left: 10px;
        border-left: 2px solid #f0f0f0;
    }

    .moment-image {
        margin-top: 15px;
        border-radius: 10px;
        overflow: hidden;
        max-width: 100%;
    }

    .moment-image img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .moment-image img:hover {
        transform: scale(1.02);
    }

    /* æ–‡ä»¶è¾“å…¥æ ·å¼ */
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
    }

    .file-input-wrapper input[type=file] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
        height: 100%;
        width: 100%;
    }

    .file-input-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px;
        background: white;
        border: 2px dashed #e0e0e0;
        border-radius: 10px;
        color: #666;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .file-input-label:hover {
        border-color: #ff6b6b;
        background: #fff9f9;
    }

    .file-selected {
        margin-top: 10px;
        font-size: 0.9rem;
        color: #666;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .file-selected.hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-heart"></i> æ‹çˆ±åŠ¨æ€</h1>
</div>

<!-- å‘å¸ƒåŠ¨æ€è¡¨å• -->
<div class="card moment-form">
    <form method="post" action="/moments/" enctype="multipart/form-data" id="moment-form">
        <div class="form-group">
            <textarea name="content" class="form-control" placeholder="è®°å½•ä¸‹è¿™ä¸€åˆ»çš„å¿ƒæƒ…ï¼Œå’ŒTAåˆ†äº«..." required rows="3"></textarea>
        </div>

        <div class="form-group">
            <div class="file-input-wrapper">
                <input type="file" name="image" id="image-input" accept="image/*" class="form-control">
                <label for="image-input" class="file-input-label">
                    <i class="fas fa-camera"></i> ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰
                </label>
            </div>
            <div id="file-selected" class="file-selected hidden">
                <i class="fas fa-check-circle"></i> <span id="file-name"></span>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-full">
            <i class="fas fa-paper-plane"></i> å‘å¸ƒåŠ¨æ€
        </button>
    </form>
</div>

<!-- åŠ¨æ€åˆ—è¡¨ -->
<!-- ä¿®æ”¹æ¨¡æ¿ä¸­çš„åŠ¨æ€åˆ—è¡¨éƒ¨åˆ† -->
<div class="moments-container">
    {% if moments %}
        {% for m in moments %}
        <div class="card moment-item" id="moment-{{ m.id }}">
            <div class="moment-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="moment-user">
                        <i class="fas fa-user-circle"></i> {{ m.user }}
                    </span>
                    <span class="moment-time">
                        <i class="far fa-clock"></i> {{ m.created_at.strftime("%Y-%m-%d %H:%M") }}
                    </span>
                </div>

                <!-- æ·»åŠ åˆ é™¤æŒ‰é’® -->
                {% if m.is_owner %}
                <button class="btn-delete-moment" data-id="{{ m.id }}" style="
                    background: #ef4444;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    padding: 5px 10px;
                    cursor: pointer;
                    font-size: 0.8rem;
                    margin-left: 10px;
                    transition: all 0.3s ease;
                ">
                    <i class="fas fa-trash"></i> åˆ é™¤
                </button>
                {% endif %}
            </div>

            <div class="moment-content">
                {{ m.content|replace("\n", "<br>")|safe }}
            </div>

            {% if m.image %}
            <div class="moment-image">
                <img src="{{ m.image }}" alt="åŠ¨æ€å›¾ç‰‡" loading="lazy">
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div class="card empty-state">
            <i class="fas fa-comment-dots empty-state-icon"></i>
            <h3>è¿˜æ²¡æœ‰åŠ¨æ€</h3>
            <p>å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€ï¼Œè®°å½•ä½ ä»¬çš„ç¾å¥½æ—¶å…‰å§ï¼</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Toast é€šçŸ¥ç»„ä»¶
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(toast);

        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => toast.classList.add('show'), 10);

        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    // æ–‡ä»¶é€‰æ‹©é¢„è§ˆ
    const imageInput = document.getElementById('image-input');
    const fileSelected = document.getElementById('file-selected');
    const fileName = document.getElementById('file-name');

    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆæ”¯æŒ JPG, PNG, GIF, WebPï¼‰');
                e.target.value = '';
                fileSelected.classList.add('hidden');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 5MBï¼‰
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB');
                e.target.value = '';
                fileSelected.classList.add('hidden');
                return;
            }

            // æ˜¾ç¤ºé€‰æ‹©çš„æ–‡ä»¶å
            fileName.textContent = file.name;
            fileSelected.classList.remove('hidden');

            // å¯é€‰ï¼šé¢„è§ˆå›¾ç‰‡
            const reader = new FileReader();
            reader.onload = function(e) {
                // å¦‚æœéœ€è¦é¢„è§ˆï¼Œå¯ä»¥åœ¨è¿™é‡Œå¤„ç†
                console.log('æ–‡ä»¶é¢„è§ˆåŠ è½½å®Œæˆ');
            };
            reader.readAsDataURL(file);
        } else {
            fileSelected.classList.add('hidden');
        }
    });
async function deleteMoment(momentId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
        return;
    }

    try {
        const response = await fetch(`/moments/${momentId}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (response.ok) {
            showToast('åŠ¨æ€å·²åˆ é™¤', 'success');

            // ä» DOM ä¸­ç§»é™¤è¯¥åŠ¨æ€
            const momentElement = document.getElementById(`moment-${momentId}`);
            if (momentElement) {
                momentElement.style.opacity = '0';
                momentElement.style.transform = 'translateX(-100px)';
                momentElement.style.transition = 'all 0.3s ease';

                setTimeout(() => {
                    momentElement.remove();

                    // å¦‚æœåˆ é™¤åæ²¡æœ‰åŠ¨æ€äº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                    const momentsContainer = document.querySelector('.moments-container');
                    if (momentsContainer.children.length === 0) {
                        momentsContainer.innerHTML = `
                            <div class="card empty-state">
                                <i class="fas fa-comment-dots empty-state-icon"></i>
                                <h3>è¿˜æ²¡æœ‰åŠ¨æ€</h3>
                                <p>å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€ï¼Œè®°å½•ä½ ä»¬çš„ç¾å¥½æ—¶å…‰å§ï¼</p>
                            </div>
                        `;
                    }
                }, 300);
            } else {
                // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ·æ–°æ•´ä¸ªåˆ—è¡¨
                refreshMoments();
            }
        } else {
            const data = await response.json();
            showToast(data.detail || 'åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// æ·»åŠ äº‹ä»¶å§”æ‰˜æ¥å¤„ç†åˆ é™¤æŒ‰é’®ç‚¹å‡»
document.addEventListener('click', function(e) {
    if (e.target.closest('.btn-delete-moment')) {
        const momentId = e.target.closest('.btn-delete-moment').dataset.id;
        deleteMoment(momentId);
    }

    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®å†…éƒ¨çš„å›¾æ ‡
    if (e.target.classList.contains('fa-trash') && e.target.closest('.btn-delete-moment')) {
        const momentId = e.target.closest('.btn-delete-moment').dataset.id;
        deleteMoment(momentId);
    }
});
    // ä¿®æ”¹è¡¨å•æäº¤äº‹ä»¶å¤„ç†å‡½æ•°
document.getElementById('moment-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = this;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');

    // éªŒè¯è¡¨å•
    const content = form.querySelector('textarea[name="content"]').value.trim();
    const file = form.querySelector('input[name="image"]').files[0];

    if (!content && !file) {
        showToast('è¯·å¡«å†™å†…å®¹æˆ–ä¸Šä¼ å›¾ç‰‡', 'error');
        return;
    }

    // å¦‚æœæœ‰æ–‡ä»¶ï¼ŒéªŒè¯å¤§å°
    if (file && file.size > 5 * 1024 * 1024) {
        showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
        return;
    }

    // ç¦ç”¨æäº¤æŒ‰é’®
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‘å¸ƒä¸­...';

    try {
        // ä½¿ç”¨ Fetch API æäº¤è¡¨å•
        const response = await fetch('/moments/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // å‘å¸ƒæˆåŠŸ
            showToast(data.message || 'å‘å¸ƒæˆåŠŸï¼');

            // æ¸…ç©ºè¡¨å•
            form.reset();
            document.getElementById('file-selected').classList.add('hidden');
            document.getElementById('file-name').textContent = '';

            // å»¶è¿Ÿ 0.5 ç§’ååˆ·æ–°åŠ¨æ€åˆ—è¡¨ï¼ˆç»™ç”¨æˆ·ä¸€ç‚¹åé¦ˆæ—¶é—´ï¼‰
            setTimeout(() => {
                refreshMoments();
            }, 500);
        } else {
            // å‘å¸ƒå¤±è´¥
            showToast(data.error || 'å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    } catch (error) {
        console.error('å‘å¸ƒå¤±è´¥:', error);
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    } finally {
        // æ¢å¤æäº¤æŒ‰é’®
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});
    async function refreshMoments() {
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const momentsContainer = document.querySelector('.moments-container');
        const originalContent = momentsContainer.innerHTML;
        momentsContainer.innerHTML = `
            <div class="loading-state" style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #ff6b6b;"></i>
                <p style="margin-top: 15px; color: #666;">åŠ è½½ä¸­...</p>
            </div>
        `;

        // è·å–æœ€æ–°çš„åŠ¨æ€åˆ—è¡¨
        const response = await fetch('/moments/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (!response.ok) {
            throw new Error('è·å–åŠ¨æ€å¤±è´¥');
        }

        const moments = await response.json();

        // æ¸²æŸ“åŠ¨æ€åˆ—è¡¨
        renderMoments(moments);
    } catch (error) {
        console.error('åˆ·æ–°åŠ¨æ€å¤±è´¥:', error);
        showToast('åˆ·æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢', 'error');

        // æ¢å¤åŸå†…å®¹
        momentsContainer.innerHTML = originalContent;
    }
}
    // åŠ è½½åŠ¨æ€åˆ—è¡¨ï¼ˆä½¿ç”¨ AJAXï¼‰
    async function loadMoments() {
        try {
            const response = await fetch('/moments/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'  // æ·»åŠ è¿™ä¸ªè¯·æ±‚å¤´
           }
        });
            const moments = await response.json();
            renderMoments(moments);
        } catch (error) {
            console.error('åŠ è½½åŠ¨æ€å¤±è´¥:', error);
        }
    }

    // æ¸²æŸ“åŠ¨æ€åˆ—è¡¨çš„å‡½æ•°
<!-- ä¿®æ”¹ timeline.html ä¸­çš„ renderMoments å‡½æ•° -->
function renderMoments(moments) {
    const container = document.querySelector('.moments-container');

    if (!moments || moments.length === 0) {
        container.innerHTML = `
            <div class="card empty-state">
                <i class="fas fa-comment-dots empty-state-icon"></i>
                <h3>è¿˜æ²¡æœ‰åŠ¨æ€</h3>
                <p>å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€ï¼Œè®°å½•ä½ ä»¬çš„ç¾å¥½æ—¶å…‰å§ï¼</p>
            </div>
        `;
        return;
    }

    // æŒ‰æ—¶é—´å€’åºæ’åº
    moments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    let html = '';
    moments.forEach(m => {
        // æ ¼å¼åŒ–æ—¶é—´
        const date = new Date(m.created_at);
        const formattedTime = date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });

        // å¤„ç†æ¢è¡Œ
        const contentWithBreaks = m.content ? m.content.replace(/\n/g, '<br>') : '';

        // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·çš„åŠ¨æ€
        const currentUser = '{{ current_user }}'; // ä»æ¨¡æ¿ä¼ å…¥
        const showDeleteButton = m.is_owner === true;


        // ç”Ÿæˆåˆ é™¤æŒ‰é’® HTML
        const deleteButtonHTML = showDeleteButton ? `
            <button class="btn-delete-moment" data-id="${m.id}" style="
                background: #ef4444;
                color: white;
                border: none;
                border-radius: 6px;
                padding: 5px 10px;
                cursor: pointer;
                font-size: 0.8rem;
                margin-left: 10px;
                transition: all 0.3s ease;
            ">
                <i class="fas fa-trash"></i> åˆ é™¤
            </button>
        ` : '';

        html += `
            <div class="card moment-item" id="moment-${m.id}">
                <div class="moment-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="moment-user">
                            <i class="fas fa-user-circle"></i> ${m.user}
                        </span>
                        <span class="moment-time">
                            <i class="far fa-clock"></i> ${formattedTime}
                        </span>
                    </div>
                    ${deleteButtonHTML}
                </div>

                <div class="moment-content">
                    ${contentWithBreaks}
                </div>

                ${m.image ? `
                <div class="moment-image">
                    <img src="${m.image}" alt="åŠ¨æ€å›¾ç‰‡" loading="lazy">
                </div>
                ` : ''}
            </div>
        `;
    });

    container.innerHTML = html;
}

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // é¦–æ¬¡åŠ è½½åŠ¨æ€
    refreshMoments();

    // æ·»åŠ æ–‡ä»¶é€‰æ‹©é¢„è§ˆçš„ä»£ç ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
    const imageInput = document.getElementById('image-input');
    const fileSelected = document.getElementById('file-selected');
    const fileName = document.getElementById('file-name');

    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆæ”¯æŒ JPG, PNG, GIF, WebPï¼‰');
                e.target.value = '';
                fileSelected.classList.add('hidden');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 5MBï¼‰
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB');
                e.target.value = '';
                fileSelected.classList.add('hidden');
                return;
            }

            // æ˜¾ç¤ºé€‰æ‹©çš„æ–‡ä»¶å
            fileName.textContent = file.name;
            fileSelected.classList.remove('hidden');
        } else {
            fileSelected.classList.add('hidden');
        }
    });
});
</script>
<style>
    /* Toast é€šçŸ¥æ ·å¼ */
    .toast-notification {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        padding: 15px 25px;
        z-index: 10000;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

    .toast-notification.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    .toast-notification.success {
        border-left: 4px solid #4CAF50;
    }

    .toast-notification.error {
        border-left: 4px solid #F44336;
    }

    .toast-content {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
    }

    .toast-notification.success .toast-content i {
        color: #4CAF50;
    }

    .toast-notification.error .toast-content i {
        color: #F44336;
    }
    /* æ·»åŠ åˆ° timeline.html çš„ extra_css å—ä¸­ */
    .loading-state {
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* æ·»åŠ å¹³æ»‘æ»šåŠ¨æ•ˆæœ */
    .moments-container {
        transition: opacity 0.3s ease;
    }

    .moments-container.loading {
        opacity: 0.5;
    }
</style>
{% endblock %}