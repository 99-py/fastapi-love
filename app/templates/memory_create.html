<!-- app/templates/memory_create.html -->
{% extends "base.html" %}

{% block title %}ğŸ“… åˆ›å»ºçºªå¿µæ—¥{% endblock %}

{% block extra_css %}
<style>
    .create-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
    }

    .create-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .create-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .create-header h1 {
        color: #ff6b6b;
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .create-header p {
        color: #666;
        font-size: 1.1rem;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }

    .form-label i {
        color: #ff6b6b;
        margin-right: 8px;
    }

    .required-mark {
        color: #ff6b6b;
    }

    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: #ff6b6b;
        box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 10px;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .radio-option input[type="radio"] {
        width: 18px;
        height: 18px;
    }

    .radio-label {
        font-size: 1rem;
        color: #333;
    }

    .icon-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    .icon-option {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        border: 2px solid #ddd;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
    }

    .icon-option:hover {
        border-color: #ff6b6b;
        transform: scale(1.1);
    }

    .icon-option.selected {
        border-color: #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
    }

    .color-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    .color-option {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #fff;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .color-option:hover {
        transform: scale(1.2);
    }

    .color-option.selected {
        border-color: #333;
        transform: scale(1.1);
    }

    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }

    .btn-submit {
        flex: 1;
        padding: 15px;
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-submit:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(255, 107, 107, 0.3);
    }

    .btn-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-cancel {
        flex: 1;
        padding: 15px;
        background: #f8f9fa;
        color: #666;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-cancel:hover {
        background: #e9ecef;
    }

    /* è¿”å›é“¾æ¥ */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        color: #666;
        text-decoration: none;
        padding: 10px 20px;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .back-link:hover {
        background: #e9ecef;
    }

    /* é”™è¯¯æç¤º */
    .error-message {
        background: #ffebee;
        color: #f44336;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }

    /* æˆåŠŸæç¤º */
    .success-message {
        background: #e8f5e9;
        color: #4CAF50;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="create-container">
    <div class="create-card">
        <div class="create-header">
            <h1><i class="fas fa-plus"></i> åˆ›å»ºçºªå¿µæ—¥</h1>
            <p>è®°å½•ä¸‹ä½ ä»¬çš„é‡è¦æ—¥å­ï¼Œè®©æ—¶å…‰çš„å°è®°æˆä¸ºæœ€çè´µçš„å›å¿†</p>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="error-message" class="error-message" style="display: none;"></div>

        <!-- æˆåŠŸæç¤º -->
        <div id="success-message" class="success-message" style="display: none;"></div>

        <form id="create-memory-form">
            <!-- çºªå¿µæ—¥åç§° -->
            <div class="form-group">
                <label class="form-label" for="title">
                    <i class="fas fa-heading"></i> çºªå¿µæ—¥åç§°
                    <span class="required-mark">*</span>
                </label>
                <input type="text" id="title" name="title" class="form-control"
                       placeholder="ä¾‹å¦‚ï¼šåœ¨ä¸€èµ·çš„ç¬¬ä¸€å¤©ã€ç¬¬ä¸€æ¬¡æ—…è¡Œ..."
                       maxlength="100" required>
            </div>

            <!-- çºªå¿µæ—¥æœŸ -->
            <div class="form-group">
                <label class="form-label" for="date">
                    <i class="far fa-calendar"></i> çºªå¿µæ—¥æœŸ
                    <span class="required-mark">*</span>
                </label>
                <input type="date" id="date" name="date" class="form-control"
                       value="{{ today }}" max="{{ today }}" required>
            </div>

            <!-- çºªå¿µæ—¥ç±»å‹ -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-tag"></i> ç±»å‹
                </label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="type-love" name="type" value="love" checked>
                        <label for="type-love" class="radio-label">â¤ï¸ çˆ±æƒ…</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="type-birthday" name="type" value="birthday">
                        <label for="type-birthday" class="radio-label">ğŸ‚ ç”Ÿæ—¥</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="type-travel" name="type" value="travel">
                        <label for="type-travel" class="radio-label">âœˆï¸ æ—…è¡Œ</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="type-custom" name="type" value="custom">
                        <label for="type-custom" class="radio-label">âœ¨ è‡ªå®šä¹‰</label>
                    </div>
                </div>
            </div>

            <!-- æè¿° -->
            <div class="form-group">
                <label class="form-label" for="description">
                    <i class="fas fa-comment"></i> æè¿°ï¼ˆå¯é€‰ï¼‰
                </label>
                <textarea id="description" name="description" class="form-control"
                          placeholder="å†™ä¸‹å…³äºè¿™ä¸ªæ—¥å­çš„ç‰¹åˆ«æ„ä¹‰å’Œå›å¿†..."
                          rows="4"></textarea>
            </div>

            <!-- å›¾æ ‡é€‰æ‹© -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-icons"></i> é€‰æ‹©å›¾æ ‡
                </label>
                <input type="hidden" id="selected-icon" name="icon" value="â¤ï¸">
                <div class="icon-options">
                    <div class="icon-option selected" data-icon="â¤ï¸" onclick="selectIcon(this)">â¤ï¸</div>
                    <div class="icon-option" data-icon="ğŸ‚" onclick="selectIcon(this)">ğŸ‚</div>
                    <div class="icon-option" data-icon="âœˆï¸" onclick="selectIcon(this)">âœˆï¸</div>
                    <div class="icon-option" data-icon="ğŸ" onclick="selectIcon(this)">ğŸ</div>
                    <div class="icon-option" data-icon="â­" onclick="selectIcon(this)">â­</div>
                    <div class="icon-option" data-icon="ğŸ¯" onclick="selectIcon(this)">ğŸ¯</div>
                    <div class="icon-option" data-icon="ğŸ’" onclick="selectIcon(this)">ğŸ’</div>
                    <div class="icon-option" data-icon="ğŸ‰" onclick="selectIcon(this)">ğŸ‰</div>
                </div>
            </div>

            <!-- é¢œè‰²é€‰æ‹© -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-palette"></i> é€‰æ‹©é¢œè‰²
                </label>
                <input type="hidden" id="selected-color" name="color" value="#ff6b6b">
                <div class="color-options">
                    <div class="color-option selected" style="background: #ff6b6b;" data-color="#ff6b6b" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #4ecdc4;" data-color="#4ecdc4" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ffd166;" data-color="#ffd166" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #95e1d3;" data-color="#95e1d3" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #a8d8ea;" data-color="#a8d8ea" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #aa96da;" data-color="#aa96da" onclick="selectColor(this)"></div>
                </div>
            </div>

            <!-- æ˜¯å¦æ¯å¹´é‡å¤ -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-redo"></i> é‡å¤è®¾ç½®
                </label>
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="is_annual" name="is_annual" value="true" checked>
                        æ¯å¹´é‡å¤çºªå¿µ
                    </label>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        å¦‚æœå–æ¶ˆå‹¾é€‰ï¼Œè¿™å°†æ˜¯åªçºªå¿µä¸€æ¬¡çš„æ—¥æœŸ
                    </small>
                </div>
            </div>

            <!-- æŒ‰é’® -->
            <div class="button-group">
                <a href="/memories" class="btn-cancel" style="text-decoration: none;">
                    <i class="fas fa-arrow-left"></i> è¿”å›
                </a>
                <button type="submit" class="btn-submit" id="submit-btn">
                    <i class="fas fa-plus"></i> åˆ›å»ºçºªå¿µæ—¥
                </button>
            </div>
        </form>

        <a href="/memories" class="back-link">
            <i class="fas fa-images"></i> è¿”å›çºªå¿µæ—¥åˆ—è¡¨
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// é€‰æ‹©å›¾æ ‡
function selectIcon(element) {
    // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.icon-option').forEach(el => {
        el.classList.remove('selected');
    });

    // æ·»åŠ é€‰ä¸­çŠ¶æ€
    element.classList.add('selected');

    // æ›´æ–°éšè—å­—æ®µ
    document.getElementById('selected-icon').value = element.dataset.icon;
}

// é€‰æ‹©é¢œè‰²
function selectColor(element) {
    // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.color-option').forEach(el => {
        el.classList.remove('selected');
    });

    // æ·»åŠ é€‰ä¸­çŠ¶æ€
    element.classList.add('selected');

    // æ›´æ–°éšè—å­—æ®µ
    document.getElementById('selected-color').value = element.dataset.color;
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(message, type = 'success') {
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');

    if (type === 'error') {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        successDiv.style.display = 'none';
    } else {
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        errorDiv.style.display = 'none';
    }

    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        if (type === 'error') {
            errorDiv.style.display = 'none';
        } else {
            successDiv.style.display = 'none';
        }
    }, 3000);
}

// è¡¨å•æäº¤
// è¡¨å•æäº¤
// è¡¨å•æäº¤
document.getElementById('create-memory-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('è¡¨å•æäº¤äº‹ä»¶è§¦å‘'); // è°ƒè¯•ä¿¡æ¯

    const title = document.getElementById('title').value.trim();
    const date = document.getElementById('date').value;
    const description = document.getElementById('description').value.trim();
    const icon = document.getElementById('selected-icon').value;
    const color = document.getElementById('selected-color').value;
    const isAnnual = document.getElementById('is_annual').checked;

    // 1. è·å–é€‰ä¸­çš„ç±»å‹ - ä¿®å¤ç©ºå€¼é—®é¢˜
    let typeElement = document.querySelector('input[name="type"]:checked');
    if (!typeElement) {
        // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„ï¼Œå°è¯•è·å–ç¬¬ä¸€ä¸ªå•é€‰æŒ‰é’®
        typeElement = document.querySelector('input[name="type"]');
        if (!typeElement) {
            showMessage('è¯·é€‰æ‹©çºªå¿µæ—¥ç±»å‹', 'error');
            return;
        }
    }
    const type = typeElement.value;

    console.log('è¡¨å•æ•°æ®:', { title, date, type, isAnnual }); // è°ƒè¯•ä¿¡æ¯

    // 2. éªŒè¯
    if (!title) {
        showMessage('è¯·å¡«å†™çºªå¿µæ—¥åç§°', 'error');
        return;
    }

    if (!date) {
        showMessage('è¯·é€‰æ‹©çºªå¿µæ—¥æœŸ', 'error');
        return;
    }

    // éªŒè¯æ—¥æœŸä¸æ˜¯æœªæ¥
    const selectedDate = new Date(date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (selectedDate > today) {
        showMessage('çºªå¿µæ—¥æœŸä¸èƒ½æ˜¯æœªæ¥æ—¥æœŸ', 'error');
        return;
    }

    // 3. æäº¤æŒ‰é’®çŠ¶æ€
    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ›å»ºä¸­...';

    try {
        // 4. ä½¿ç”¨ FormData
        const formData = new FormData();
        formData.append('title', title);
        formData.append('date_str', date);  // æ³¨æ„åç«¯å‚æ•°æ˜¯ date_str
        formData.append('type', type);
        formData.append('description', description || '');
        formData.append('icon', icon);
        formData.append('color', color);
        formData.append('is_annual', isAnnual);
        formData.append('is_public', 'true');

        // è°ƒè¯•ï¼šæŸ¥çœ‹ FormData å†…å®¹
        console.log('FormData å†…å®¹:');
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }

        const response = await fetch('/memories/create', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
                // ä¸è¦è®¾ç½® Content-Typeï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è®¾ç½®
            }
        });

        console.log('å“åº”çŠ¶æ€:', response.status); // è°ƒè¯•ç”¨

        if (response.ok) {
            const data = await response.json();
            console.log('å“åº”æ•°æ®:', data); // è°ƒè¯•ç”¨
            showMessage('çºªå¿µæ—¥åˆ›å»ºæˆåŠŸï¼', 'success');

            // å»¶è¿Ÿ 1.5 ç§’åè·³è½¬
            setTimeout(() => {
                window.location.href = '/memories';
            }, 1500);
        } else {
            let errorMessage = 'åˆ›å»ºå¤±è´¥';
            try {
                const error = await response.json();
                errorMessage = error.detail || error.message || JSON.stringify(error);
            } catch (e) {
                errorMessage = `æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`;
            }
            console.error('åˆ›å»ºå¤±è´¥:', errorMessage); // è°ƒè¯•ç”¨
            showMessage(`åˆ›å»ºå¤±è´¥: ${errorMessage}`, 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('åˆ›å»ºå¤±è´¥:', error);
        showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

// é¡µé¢åŠ è½½æ—¶è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
});
</script>
{% endblock %}